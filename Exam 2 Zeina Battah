from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.tree import DecisionTreeClassifier
from sklearn.preprocessing import StandardScaler, OneHotEncoder
from sklearn.metrics import classification_report, ConfusionMatrixDisplay
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# Function to preprocess data
def preprocess_data(data):
    # Drop unnecessary columns
    data = data.drop(columns=['Unnamed: 0', 'air_time', 'year', 'month', 'day', 'dest', 'dep_time'])

    # Create target columns
    data['is_delayed'] = data['dep_delay'].apply(lambda x: 1 if x >= 30 else 0)  # On-time vs Delayed
    data['delay_severity'] = data['dep_delay'].apply(lambda x: 1 if 30 <= x <= 120 else (2 if x > 120 else None))  # Minor/Major

    # Drop dep_delay to avoid leakage
    data = data.drop(columns=['dep_delay'])

    # Fill missing values
    data = data.fillna(data.median(numeric_only=True))  # Fill numeric columns with median
    categorical_cols = ['carrier', 'origin', 'type', 'manufacturer', 'model', 'engine']
    for col in categorical_cols:
        data[col] = data[col].fillna(data[col].mode()[0])  # Fill categorical columns with mode

    return data

# Load and preprocess the dataset
data = pd.read_csv('flight_data_full.csv')
data = preprocess_data(data)

# Define categorical and numerical columns
categorical_cols = ['carrier', 'origin', 'type', 'manufacturer', 'model', 'engine']
numerical_cols = ['hour', 'seats', 'carrier_delay', 'origin_delay', 'dest_delay', 'flight_volume', 'temp', 'humid']

# One-hot encode categorical columns
encoder = OneHotEncoder(handle_unknown='ignore')
encoded_cats = encoder.fit_transform(data[categorical_cols]).toarray()
encoded_cat_cols = encoder.get_feature_names_out(categorical_cols)

# Scale numerical columns
scaler = StandardScaler()
scaled_nums = scaler.fit_transform(data[numerical_cols])

# Combine processed features
X_full = np.hstack([scaled_nums, encoded_cats])
X = pd.DataFrame(X_full, columns=list(numerical_cols) + list(encoded_cat_cols))

# -----------------------------
# First Stage: On-time vs Delayed
# -----------------------------
y_first_stage = data['is_delayed']

X_train, X_test, y_train, y_test = train_test_split(X, y_first_stage, test_size=0.3, random_state=42)

rf_model = RandomForestClassifier(
    class_weight='balanced', ccp_alpha=0, max_depth=None, min_samples_split=2,
    max_features='sqrt', n_estimators=200, random_state=42
)

rf_model.fit(X_train, y_train)
y_pred_rf = rf_model.predict(X_test)

print("First Stage: On-time vs Delayed")
print(classification_report(y_test, y_pred_rf, target_names=['On-time', 'Delayed']))

# Adjusted threshold
y_pred_prob_rf = rf_model.predict_proba(X_test)[:, 1]  # Probability for delayed class
threshold = 0.15  # Adjusted threshold
y_pred_adjusted_rf = (y_pred_prob_rf >= threshold).astype(int)  # Thresholded predictions

print("First Stage (Adjusted Threshold): On-time vs Delayed")
print(classification_report(y_test, y_pred_adjusted_rf, target_names=['On-time', 'Delayed']))

# -----------------------------
# Second Stage: Minor vs Major Delays
# -----------------------------

# Use only delayed flights predicted by the first stage
delayed_indices = (y_pred_adjusted_rf == 1)  # Flights predicted as delayed
X_test_delayed = X_test[delayed_indices]  # Features of delayed flights
y_test_delayed_actual = data.iloc[X_test_delayed.index]['delay_severity']  # True delay severity

# Prepare second-stage training data
data_delayed = data[data['delay_severity'].notna()]  # Keep only delayed flights
X_delayed_full = pd.concat(
    [pd.DataFrame(scaler.transform(data_delayed[numerical_cols]), columns=numerical_cols),
     pd.DataFrame(encoder.transform(data_delayed[categorical_cols]).toarray(), columns=encoded_cat_cols)], axis=1
)
y_delayed = data_delayed['delay_severity']  # Minor (1) or Major (2)

# Split delayed data into training and testing sets for the second stage
X_train_delayed, X_test_delayed, y_train_delayed, y_test_delayed = train_test_split(
    X_delayed_full, y_delayed, test_size=0.3, random_state=42
)

dt_model = DecisionTreeClassifier(random_state=42, max_depth=5, class_weight='balanced')
dt_model.fit(X_train_delayed, y_train_delayed)

# Predict and evaluate for delayed flights
y_pred_dt = dt_model.predict(X_test_delayed)

print("Second Stage: Minor vs Major Delays")
print(classification_report(y_test_delayed, y_pred_dt, target_names=['Minor Delay', 'Major Delay']))

# Plot confusion matrix for the second stage
ConfusionMatrixDisplay.from_estimator(dt_model, X_test_delayed, y_test_delayed,
                                       display_labels=['Minor Delay', 'Major Delay'], cmap=plt.cm.Blues)
plt.title("Confusion Matrix for Minor vs Major Delays")
plt.show()
